name: CI/CD

on:
  push:
    branches: [ "main", "claude/**" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive

    - name: Set up Python 3.10
      uses: actions/setup-python@v6
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Lint with flake8
      run: |
        # Stop on Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=vendor,external
        # Treat all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=vendor,external

    - name: Check code formatting with black
      run: |
        black --check --diff --exclude="(vendor|external)" . || echo "::warning::Code formatting issues found. Run 'black .' to fix."

    - name: Check import sorting with isort
      run: |
        isort --check-only --diff --skip vendor --skip external . || echo "::warning::Import sorting issues found. Run 'isort .' to fix."

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-xdist
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # Install optional dev dependencies
        pip install -e ".[dev,analysis]" || true

    - name: Run tests with pytest
      run: |
        pytest -v --cov=. --cov-report=xml --cov-report=term --maxfail=5 -n auto

    - name: Upload coverage to artifact
      if: matrix.python-version == '3.10'
      uses: actions/upload-artifact@v5
      with:
        name: coverage-report
        path: coverage.xml
        retention-days: 30

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive

    - name: Set up Python 3.10
      uses: actions/setup-python@v6
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: python -m build

    - name: Check package
      run: twine check dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v5
      with:
        name: dist-packages
        path: dist/
        retention-days: 30

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test]
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive

    - name: Set up Python 3.10
      uses: actions/setup-python@v6
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install -e ".[dev,analysis]" || true

    - name: Run MotorHand validation
      run: |
        python run_motorhand_validation.py || echo "::warning::MotorHand validation completed with warnings"

    - name: Run RPO burn verification
      run: |
        python verify_burn_ratio.py || echo "::warning::RPO burn verification completed with warnings"

    - name: Test neurorobotic control
      run: |
        python -c "import neurorobotic_control; print('âœ“ Neurorobotic control module imports successfully')"

    - name: Test neurorobotic hardware bridge
      run: |
        python -c "import neurorobotic_hardware_bridge; print('âœ“ Neurorobotic hardware bridge module imports successfully')"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build, integration-test]
    if: always()
    steps:
    - name: Check job statuses
      run: |
        echo "## ðŸ” CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Test | ${{ needs.integration-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.lint.result }}" == "failure" ] || [ "${{ needs.test.result }}" == "failure" ] || [ "${{ needs.build.result }}" == "failure" ]; then
          echo "âŒ CI/CD pipeline failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… CI/CD pipeline passed" >> $GITHUB_STEP_SUMMARY
        fi
